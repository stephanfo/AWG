{% extends "UserBundle::layout.html.twig" %}

{% block title %}
    {{ 'Galerie' | trans }} - {{ parent() }}
{% endblock %}

{% block body %}
    {% if not galleries is empty %}
        {% if appConfig.gallerySingleGallery and appConfig.galleryQuickLink and listGalleriesAndCount | length > 1 %}
            <div class="form-group form-inline gallery-quick-link">
                <select quickLink-select class="form-control">
                    {% for galleryAndCount in listGalleriesAndCount %}
                        <option value="{{ galleryAndCount.galleryEntity.id }}"{% if galleryAndCount.galleryEntity.id == oneGallery %} selected{% endif %}>{{ galleryAndCount.galleryEntity.title | truncate(20) }} ({{ galleryAndCount.photoCount }})</option>
                    {% endfor %}
                </select>
            </div>
        {% endif %}
        {% for gallery in galleries %}
            {% if appConfig.galleryQuickLink and galleries | length > 1 %}
                <div class="form-group form-inline gallery-quick-link">
                    <select quickScroll-select class="form-control">
                        <option value="0">{{ 'Accès rapide' | trans }}</option>
                        {% for gallery in galleries %}
                            <option value="quickScroll-{{ loop.index }}">{{ gallery.title | truncate(20) }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            <h4 id="quickScroll-{{ loop.index }}" class="page-header">{{ gallery.title }} <small>(<i>{{ gallery.photos | length }} {{ 'photos' | trans }})</i></small></h4>
            <p>
                {{ gallery.detail | raw }}
            </p>
            <p>&nbsp;</p>
            {% if not gallery.photos is empty %}
                <div class="row">
                    <div class="col-lg-12">
                        <div id="grid" data-columns>
                            {% for photo in gallery.photos %}
                                <div class="thumbnail">
                                    {% if is_granted('ROLE_BIGPICTURE') %}
                                        <a href="{{ vich_uploader_asset(photo, 'imageFile') }}" data-lightbox="gallery" data-title="Photo {{ photo.title }}, Taille {{ photo.imageWidth }}x{{ photo.imageHeight }}">
                                            <img id="img-{{ photo.id }}" class="img-responsive" src="{{ vich_uploader_asset(photo, 'imageFile') | imagine_filter('gallery_thumb') }}" alt="{{ photo.title }}"/>
                                        </a>
                                    {% else %}
                                        <a href="{{ vich_uploader_asset(photo, 'imageFile') | imagine_filter('watermark_thumb')  }}" data-lightbox="gallery" data-title="Photo {{ photo.title }}, Taille {{ photo.imageWidth }}x{{ photo.imageHeight }}">
                                            <img id="img-{{ photo.id }}" class="img-responsive" src="{{ vich_uploader_asset(photo, 'imageFile') | imagine_filter('gallery_thumb') }}" alt="{{ photo.title }}"/>
                                        </a>
                                    {% endif %}
                                    <div class="caption">
                                        <p class="image-caption">
                                            {{ photo.title | truncate(14) }}
                                        </p>
                                        <p class="image-caption">
                                            {% if is_granted('IS_AUTHENTICATED_REMEMBERED')  %}
                                                <button type="button" photo-like="{{ photo.id }}" class="btn {% if attribute(likes, photo.id) is defined %}btn-success{% else %}btn-default{% endif %} btn-xs"><i class="glyphicon glyphicon-thumbs-up"></i> <span photo-like-count="{{ photo.id }}">{{ photo.likeCount }}</span></button>
                                                &nbsp;
                                                <button type="button" photo-cart="{{ photo.id }}" class="btn {% if attribute(carts, photo.id) is defined %}btn-info{% else %}btn-default{% endif %} btn-xs"><i class="glyphicon glyphicon-shopping-cart"></i></button>
                                            {% else %}
                                                <a href="{{ path('fos_user_registration_register') }}"><button type="button" class="btn btn-default btn-xs"><i class="glyphicon glyphicon-thumbs-up"></i> <span photo-like-count="{{ photo.id }}">{{ photo.likeCount }}</span></button></a>
                                                &nbsp;
                                                <a href="{{ path('fos_user_registration_register') }}"><button type="button" class="btn btn-default btn-xs"><i class="glyphicon glyphicon-shopping-cart"></i></button></a>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            <div class="bottom-block">
                <div class="bottom-block-right">
                    <a href="{{ path('cart') }}"><button type="button" class="btn btn-success bottom-button"><i class="glyphicon glyphicon-shopping-cart"></i> {{ 'Mon panier' | trans }}</button></a>
                </div>
            </div>
            {% if not loop.last and appConfig.gallerySingleGallery == false %}
                <hr>
            {% endif %}
        {% endfor %}
    {% else %}
        {{ 'Aucune galerie accessible' | trans }}
    {% endif %}
    {% if appConfig.gallerySingleGallery and listGalleriesAndCount | length > 1 %}
        <hr>
        <h4>{{ 'Liste des galeries' | trans }}</h4>
        <table class="table table-striped">
            <thead>
            <tr>
                <th>{{ 'Nom de la galerie' | trans }}</th>
                <th style="text-align: center;">{{ 'Photos' | trans }}</th>
                <th style="text-align: right;">{{ 'Ouvrir' | trans }}</th>
            </tr>
            </thead>
            <tbody>
            {% for galleryAndCount in listGalleriesAndCount %}
                <tr {% if galleryAndCount.galleryEntity.id == oneGallery %}class="info"{% endif %}>
                    <td>{{ galleryAndCount.galleryEntity.title | truncate(20) }}</td>
                    <td style="text-align: center;">{{ galleryAndCount.photoCount }}</td>
                    <td style="text-align: right;"><a href="{{ path('home_one_gallery', { 'oneGallery': galleryAndCount.galleryEntity.id }) }}"><button type="button" class="btn btn-xs btn-default"><li class="glyphicon glyphicon-arrow-right"></li></button></a></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <div id="addToCart" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Ajouter la photo au panier</h4>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <img id="img-cart" src="">
                    </div>
                    <hr>
                    {% if formats is not empty %}
                        {% for format in formats %}
                            <div class="form-group form-inline text-center">
                                <label for="format-{{ format.id }}" class="control-label">Format {{ format.size }} : </label>
                                <div class="input-group">
                                    <span class="input-group-addon btn btn-primary" cart-quantity-minus="format-{{ format.id }}"><i class="glyphicon glyphicon-minus"></i></span>
                                    <input type="number" min="0" class="form-control" cart-photo="0" cart-format="{{ format.id }}" value="" id="format-{{ format.id }}">
                                    <span class="input-group-addon btn btn-primary" cart-quantity-plus="format-{{ format.id }}"><i class="glyphicon glyphicon-plus"></i></span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>
                            {{ 'Aucun format d\'impression n\'a été définit.' | trans }}
                        </p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <a><button type="button" class="btn btn-primary bottom-button" data-dismiss="modal"><i class="glyphicon glyphicon-backward"></i> {{ 'Continuer mes achats' | trans }}</button></a>
                    <a href="{{ path('cart') }}"><button type="button" class="btn btn-success bottom-button"><i class="glyphicon glyphicon-shopping-cart"></i> {{ 'Finaliser ma commande' | trans }}</button></a>
                </div>
            </div>

        </div>
    </div>

    {{ render(controller('UserBundle:Discount:bottomBar')) }}
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('resources/salvattore/salvattore.min.js') }}"></script>
    <script type="text/javascript">
        {% if is_granted('IS_AUTHENTICATED_REMEMBERED') %}
        {#
            If any cart button is clicked, then load picture, quantities and show the modal
        #}
        $('[photo-cart]').click(function () {
            {# Load the picture in the modal and store the photo ID #}
            $('#img-cart').attr('src', $('#img-' + $(this).attr('photo-cart')).attr('src'));
            var photoId = $(this).attr('photo-cart');
            {# Get the quantities, store in the fields, then show the modal #}
            $.get('{{ path('cart_quantities_empty_link') }}' + $(this).attr('photo-cart'), function (data) {
                {# Loop to all input format, then set 0 or preselected quantity #}
                $('[cart-format]').each(function () {
                    $(this).attr('cart-photo', photoId);
                    if($(this).attr('cart-format') in data['formatsQuantities'])
                    {
                        $(this).val(data['formatsQuantities'][$(this).attr('cart-format')]);
                    }
                    else
                    {
                        $(this).val(0);
                    }
                });
                {# Lauch the modal #}
                $('#addToCart').modal('show');
            })
        });
        {#
            If one of the +/- buttons is clicked, then change the value and ask the server to update
        #}
        $('[cart-quantity-minus]').click(function () {
            var quantityInput = $('#' + $(this).attr('cart-quantity-minus'));
            updateQuantity(quantityInput, -1);
        });

        $('[cart-quantity-plus]').click(function () {
            var quantityInput = $('#' + $(this).attr('cart-quantity-plus'));
            updateQuantity(quantityInput, +1);
        });

        $('input[cart-photo][cart-format]').change(function () {
            var quantityInput = $(this);
            updateQuantity(quantityInput, 0);
        });

        function updateQuantity(quantityInput, increment)
        {
            var quantityValue = quantityInput.val();

            if ($.isNumeric(quantityValue) && (Math.ceil(quantityValue) + increment) > 0)
                quantityValue = Math.ceil(quantityValue) + increment;
            else
                quantityValue = 0;

            $.get('{{ path('cart_update_empty_link') }}' + quantityInput.attr('cart-photo') + "/" + quantityInput.attr('cart-format') + "/" + quantityValue, function (data) {
                quantityInput.val(data['quantity']);
                if(data['inCart'])
                {
                    $('[photo-cart="' + data['photo'] + '"]').removeClass('btn-default');
                    $('[photo-cart="' + data['photo'] + '"]').addClass('btn-info');
                }
                else
                {
                    $('[photo-cart="' + data['photo'] + '"]').removeClass('btn-info');
                    $('[photo-cart="' + data['photo'] + '"]').addClass('btn-default');
                }
            });
        }
        {#
            Is like button is clicked, like or unlike
        #}
        $('[photo-like]').click(function () {
            $.get('{{ path('like_toggle_empty_link') }}' + $(this).attr('photo-like'), function (data) {
                if (data['like'])
                {
                    $('[photo-like="' + data['id'] + '"]').removeClass('btn-default');
                    $('[photo-like="' + data['id'] + '"]').addClass('btn-success');
                } else
                {
                    $('[photo-like="' + data['id'] + '"]').removeClass('btn-success');
                    $('[photo-like="' + data['id'] + '"]').addClass('btn-default');
                }
                $('[photo-like-count="' + data['id'] + '"]').text(data['count']);
            });
        });
        {% endif %}
        {% if appConfig.galleryQuickLink and galleries | length > 1 %}
        $('[quickScroll-select]').on('change', function () {
            if (this.value != 0)
            {
                var target = this.value;
                this.value = 0;
                $('html, body').animate({scrollTop: $('#' + target).offset().top }, 1000);
            }
        });
        {% endif %}
        {% if appConfig.gallerySingleGallery and appConfig.galleryQuickLink %}
        $('[quickLink-select]').on('change', function () {
            location.href = "{{ path('home') }}" + this.value;
        });
        {% endif %}
    </script>
{% endblock %}
